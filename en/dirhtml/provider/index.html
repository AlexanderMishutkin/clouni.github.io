<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>Adding new provider &#8212; Clouni 1.0.0 documentation</title>
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/basic.css" />
    <link rel="stylesheet" type="text/css" href="../_static/my-styles.css" />
    <link rel="stylesheet" href="../_static/bootswatch-3.3.4/yeti/bootstrap.min.css" type="text/css" />
    <link rel="stylesheet" href="../_static/bootstrap-sphinx.css" type="text/css" />
    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/js/jquery-1.11.0.min.js"></script>
    <script src="../_static/js/jquery-fix.js"></script>
    <script src="../_static/bootstrap-3.3.4/js/bootstrap.min.js"></script>
    <script src="../_static/bootstrap-sphinx.js"></script>
    <link rel="author" title="About these documents" href="../about/" />
    <link rel="index" title="Index" href="../genindex/" />
    <link rel="search" title="Search" href="../search/" />
    <link rel="next" title="Filter conditions" href="../conditions/" />
    <link rel="prev" title="gRPC client-server" href="../server/" />
<meta charset='utf-8'>
<meta http-equiv='X-UA-Compatible' content='IE=edge,chrome=1'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1'>
<meta name="apple-mobile-web-app-capable" content="yes">

  </head><body>

<div id="navbar" class="navbar navbar-inverse navbar-default navbar-fixed-top">
  <div class="container">
    <div class="navbar-header">
      <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".nav-collapse">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="../">
        Clouni</a>
      <span class="navbar-text navbar-version pull-left"><b></b></span>
    </div>

      <div class="collapse navbar-collapse nav-collapse">
        <ul class="nav navbar-nav">
          
              <li><a href="../../../ru/dirhtml/">Russian Version</a></li>
          
          
          
          
        </ul>

        
          
<form class="navbar-form navbar-right" action="../search/" method="get">
 <div class="form-group">
  <input type="text" name="q" class="form-control" placeholder="Search" />
 </div>
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
        
        
          
            <ul class='nav navbar-nav navbar-right'>
                
  <li>
    <a href="../server/" title="Previous Chapter: gRPC client-server"><span class="glyphicon glyphicon-chevron-left visible-sm"></span><span class="hidden-sm hidden-tablet">&laquo; gRPC client-server</span>
    </a>
  </li>
  <li>
    <a href="../conditions/" title="Next Chapter: Filter conditions"><span class="glyphicon glyphicon-chevron-right visible-sm"></span><span class="hidden-sm hidden-tablet">Filter conditions &raquo;</span>
    </a>
  </li>
            </ul>
          
        
      </div>
  </div>
</div>

<div class="container">
  <div class="row">
      <div class="col-md-3">
        <div id="sidebar" class="bs-sidenav" role="complementary"><p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../about/">About</a></li>
<li class="toctree-l1"><a class="reference internal" href="../install/">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../use/">CLI usage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../server/">gRPC client-server</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Adding new provider</a></li>
<li class="toctree-l1"><a class="reference internal" href="../conditions/">Filter conditions</a></li>
</ul>

        </div>
      </div>
    <div class="col-md-9 content">
      
  <section id="adding-new-provider">
<h1>Adding new provider<a class="headerlink" href="#adding-new-provider" title="Permalink to this headline">¶</a></h1>
<p>Template of project files structure:</p>
<p><code class="docutils literal notranslate"><span class="pre">`textmate</span>
<span class="pre">.ansible/</span>
<span class="pre">|--</span> <span class="pre">plugins</span>
<span class="pre">|</span>&#160;&#160; <span class="pre">|--</span> <span class="pre">module_utils</span>
<span class="pre">|</span>&#160;&#160; <span class="pre">|</span>&#160;&#160; <span class="pre">|--</span> <span class="pre">cloud_infra_by_tosca.py</span>
<span class="pre">toscatranslator/</span>
<span class="pre">|--</span> <span class="pre">providers</span>
<span class="pre">|</span>&#160;&#160; <span class="pre">|--</span> <span class="pre">&lt;provider&gt;</span>
<span class="pre">|</span>&#160;&#160; <span class="pre">|</span>&#160;&#160; <span class="pre">|--</span> <span class="pre">provider.cfg</span>
<span class="pre">|</span>&#160;&#160; <span class="pre">|</span>&#160;&#160; <span class="pre">|--</span> <span class="pre">tosca_elements_map_to_provider.json</span>
<span class="pre">|</span>&#160;&#160; <span class="pre">|</span>&#160;&#160; <span class="pre">|--</span> <span class="pre">TOSCA_&lt;provider&gt;_definition_1_0.yaml</span>
<span class="pre">`</span></code></p>
<p>The <cite>&lt;provider&gt;</cite> means the provider’s unique nic. Adding new provider
includes several steps.</p>
<section id="prestep-considering-main-components-of-cloud">
<h2>Prestep: considering main components of cloud<a class="headerlink" href="#prestep-considering-main-components-of-cloud" title="Permalink to this headline">¶</a></h2>
<p>There is set of common parameters to launch virtual machine. This
parameters are manages in different ways by different providers and a
unified by TOSCA.</p>
<ul class="simple">
<li><p><em>private address</em> - the primary private IP address assigned by the cloud provider that applications may use to access the Compute node.</p></li>
<li><p><em>public address</em> - he primary public IP address assigned by the cloud provider that applications may use to access the Compute node.</p></li>
<li><p><em>networks/ports</em>: network names or ids or port names or ids or addresses</p></li>
<li><p><em>host</em>: number of CPUs, disk size, RAM size or CPU frequency</p></li>
<li><dl class="simple">
<dt><em>endpoint</em> - network access endpoint capability</dt><dd><ul>
<li><p><em>protocol</em> - http, https, ftp, tcp, udp, etc</p></li>
<li><p><em>port</em> of endpoint</p></li>
<li><p><em>url path</em> of endpoint’s address if applicable for the protocol</p></li>
<li><p><em>port name</em> which endpoint should be bound to</p></li>
<li><p><em>network name</em> which endpoint should be bound to</p></li>
<li><p><em>initiator</em> - one of: source, target, peer</p></li>
<li><p><em>IP address</em> as propagated up by the associated node’s host (Compute)
container</p></li>
<li><p>if <em>secured</em> connection</p></li>
</ul>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt><em>os</em> - operating system parameters:</dt><dd><ul>
<li><p><em>architecture</em> - x86_32, x86_64, etc.</p></li>
<li><p><em>type</em> - linux, aix, mac, windows, etc.</p></li>
<li><p><em>distribution</em> -  debian, fedora, rhel and ubuntu</p></li>
<li><p><em>version</em></p></li>
</ul>
</dd>
</dl>
</li>
<li><p><em>scalable</em>: min, default, max of instances to launch</p></li>
<li><p><em>volumes</em>: local storages</p></li>
</ul>
</section>
<section id="step-1-defining-main-components-of-cloud-provider">
<h2>Step 1: Defining main components of cloud provider<a class="headerlink" href="#step-1-defining-main-components-of-cloud-provider" title="Permalink to this headline">¶</a></h2>
<p>Prestep results in set of virtual cloud resources containing required
parameters (instances, images, security groups, etc.)</p>
<p>Define main components definitions in language specified by TOSCA.</p>
<p>The template of definition file must be:</p>
<p><a href="#id1"><span class="problematic" id="id2">``</span></a><a href="#id3"><span class="problematic" id="id4">`</span></a>yaml
tosca_definitions_version: tosca_simple_yaml_1_0
capability_types:</p>
<blockquote>
<div><dl class="simple">
<dt>&lt;provider&gt;.capabilities.Root:</dt><dd><p>derived_from: tosca.capabilities.Root</p>
</dd>
</dl>
<p>&lt;…&gt;</p>
</div></blockquote>
<dl>
<dt>node_types:</dt><dd><dl>
<dt>&lt;provider&gt;.nodes.Root:</dt><dd><p>derived_from: tosca.nodes.Root
capabilities:</p>
<blockquote>
<div><dl class="simple">
<dt>feature:</dt><dd><p>type: &lt;provider&gt;.capabilities.Node
occurrences: [ 1, 1 ]</p>
</dd>
</dl>
</div></blockquote>
<dl class="simple">
<dt>requirements:</dt><dd><ul class="simple">
<li><dl class="simple">
<dt>dependency:</dt><dd><p>capability: &lt;provider&gt;.capabilities.Node
node: &lt;provider&gt;.nodes.Root
relationship: &lt;provider&gt;.relationships.DependsOn
occurrences: [ 0, UNBOUNDED ]</p>
</dd>
</dl>
</li>
</ul>
</dd>
</dl>
</dd>
</dl>
<p>&lt;…&gt;</p>
</dd>
<dt>relationship_types:</dt><dd><dl class="simple">
<dt>&lt;provider&gt;.relationships.DependsOn:</dt><dd><p>description: This type results in ordering of initializing objects.
derived_from: tosca.relationships.DependsOn
valid_target_types: [ &lt;provider&gt;.capabilities.Node ]</p>
</dd>
</dl>
<p>&lt;…&gt;</p>
</dd>
</dl>
<p><a href="#id5"><span class="problematic" id="id6">``</span></a><a href="#id7"><span class="problematic" id="id8">`</span></a></p>
<p>Examples can be found in <cite>toscatranslator/providers/&lt;provider&gt;</cite>
directories.</p>
</section>
<section id="step-2-defining-mapping-between-tosca-nodes-compute-and-main-components-of-cloud-provider">
<h2>Step 2: Defining mapping between tosca.nodes.Compute and main components of cloud provider<a class="headerlink" href="#step-2-defining-mapping-between-tosca-nodes-compute-and-main-components-of-cloud-provider" title="Permalink to this headline">¶</a></h2>
<p>This step is the declarative defining of mapping considered in Prestep
using definitions from Step 1.</p>
<p>This mapping represents in either JSON or YAML format. Further the rules
to describe the mapping are provided.</p>
<p>The parameters of TOSCA normative node type are determined as keys, and
the parameters of the provider node types are determined as values. All
parameters name must include the node type and the parameter section and
name, which called <em>extended parameter name</em>. For example,
<cite>tosca.nodes.Compute.attributes.private_address</cite>.</p>
<p>The values are represented in format, called <em>value format</em>. The value
format can be of type list, map and string. If the value is of type map,
then it’s one of the following cases:</p>
<ul class="simple">
<li><p>keys are <cite>parameter</cite>, <cite>value</cite>, <cite>keyname</cite>: <cite>parameter</cite> contains the name
of the specialized type parameter, the <cite>value</cite> contains the value of
this parameter, <cite>keyname</cite> specialises the name of the node topology in
which to add this parameter, <cite>keyname</cite> can be used to create several
nodes of the same type. Be attentive and sure you don’t set existing names.
Example:</p></li>
</ul>
<p>~~~yaml
tosca.nodes.Compute.capabilities.host.properties</p>
<blockquote>
<div><p>.num_cpus:</p>
</div></blockquote>
<dl class="simple">
<dt>parameter: openstack.nodes.Server.requirements</dt><dd><p>.flavor.node_filter.properties.vcpus</p>
</dd>
</dl>
<p>value: {self[value]}
~~~
* keys are <cite>error</cite>, <cite>reason</cite>: used if the parameter cannot be specified</p>
<blockquote>
<div><p>in TOSCA template for a certain reason.</p>
</div></blockquote>
<ul class="simple">
<li><p>keys are <cite>source</cite>, <cite>parameters</cite>, <cite>extra</cite>, <cite>value</cite>, <cite>executor</cite>: used to
add operation implementation and hence create a relationship, <cite>source</cite>
represents the name of ansible module or any other command or source
of a specific executor or the file name to execute,
<cite>parameters</cite> are the arguments of the source,
<cite>extra</cite> is the extra info, if Ansible is used <cite>parameters</cite> are the
arguments of module and <cite>extra</cite> are the extra parameters of the task,
<cite>value</cite> represents variable name passing after script execution,
it can be unnecessary but must be defined any way,
<cite>executor</cite> represents the configuration tool or some
another supported executor (ex. ansible, python). Example:</p></li>
</ul>
<p>~~~yaml
- source: set_fact</p>
<blockquote>
<div><p>executor: ansible
parameters:</p>
<blockquote>
<div><p>new_var: 1</p>
</div></blockquote>
<p>value: tmp_value</p>
</div></blockquote>
<p># example with python script
- source: transform_units</p>
<blockquote>
<div><dl class="simple">
<dt>parameters:</dt><dd><p>source_value: “{self[value]}”
is_without_b: True</p>
</dd>
</dl>
<p>executor: python
value: default</p>
</div></blockquote>
<p>~~~</p>
<ul class="simple">
<li><p>keys are <cite>value</cite>, <cite>condition</cite>, <cite>facts</cite>, <cite>arguments</cite>, <cite>executor</cite>: used if the value must
be first chosen from existing cloud resources, <cite>facts</cite> represents the source which is use to get list
of cloud resources paramters, facts need to be filtered for some value satisfying some <cite>condition</cite> and its
<cite>arguments</cite>. Three conditions are supported: <cite>equals</cite>, <cite>contains</cite>, <cite>ip_contains</cite>. Example:</p></li>
</ul>
<p>~~~yaml
tosca.nodes.Compute.attributes.networks.*</p>
<blockquote>
<div><p>.addresses:</p>
</div></blockquote>
<dl>
<dt>parameter: openstack.nodes.Server.requirements</dt><dd><p>.nics.node_filter.properties.id</p>
</dd>
<dt>value:</dt><dd><ul class="simple">
<li><p>value: network_id</p></li>
</ul>
<p>condition: ip_contains
facts: os_subnets_facts.ansible_facts.openstack_subnets
executor: ansible
arguments:
- allocation_pool_start
- allocation_pool_end
- “{self[value]}”</p>
</dd>
</dl>
<p>~~~</p>
<p><strong>ATTENTION</strong>. Please don’t use reserved keys in you mapping values,
ex. replace ‘parameter’ key by ‘input_parameter’.</p>
<p>The interpreter also defines a variable <cite>self</cite> that can be used to store
and read some values in a key-value format. For example:</p>
<p>~~~yaml
tosca.nodes.Compute.endpoint.attributes.ip_address:</p>
<blockquote>
<div><p>parameter: {self[buffer][security_group_rule][cidr_ip]}
value: {self[value]}</p>
</div></blockquote>
<dl>
<dt>tosca.nodes.Compute.endpoint.properties.initiator.target:</dt><dd><p>parameter: amazon.nodes.SecurityGroup.properties.rules
value:</p>
<blockquote>
<div><ul class="simple">
<li><p>{self[buffer][security_group_rule]}</p></li>
</ul>
</div></blockquote>
</dd>
</dl>
<p>~~~</p>
<p>There are also predefined values:
* <cite>parameter</cite> contains the extended name of TOSCA normative type parameter
* <cite>value</cite> contains the value defined by the key <cite>parameter</cite> in TOSCA</p>
<blockquote>
<div><p>template</p>
</div></blockquote>
<ul class="simple">
<li><p><cite>name</cite> contains the current node name</p></li>
</ul>
<p>As a result, any updates of cloud API or new versions of TOSCA standard
causes only minor changes in the interpreter cloud definitions, which
simplifies the process of adding a new cloud provider support.</p>
<p><strong>ATTENTION</strong> You shouldn’t use multiple type deriviation from each other
except default deriviation from Root. As it’s unknown actions to resolve
dependencies from parents.</p>
</section>
<section id="step-3-provider-configuration-file">
<h2>Step 3: Provider configuration file<a class="headerlink" href="#step-3-provider-configuration-file" title="Permalink to this headline">¶</a></h2>
<p>Every provider is configured with configuration file which can be one
the following (sorted by priority):
1. <cite>&lt;provider&gt;.cfg</cite> in the working directory where user executes Clouni
1. <cite>toscatranslator/providers/&lt;provider&gt;/provider.cfg</cite> in <cite>$TOSCA_HOME</cite>
1. <cite>toscatranslator/providers/&lt;provider&gt;/&lt;provider&gt;.cfg</cite> in <cite>$TOSCA_HOME</cite></p>
<p><cite>&lt;provider&gt;</cite> means provider’s nic in Clouni</p>
<p>It has required settings for Clouni execution:</p>
<p>~~~ini
[main]
tosca_elements_definition_file = TOSCA_openstack_definition_1_0.yaml
tosca_elements_map_file = tosca_elements_map_to_openstack.yaml
~~~</p>
<ul class="simple">
<li><p><cite>tosca_elements_definition_file</cite> points to the name of the file created in Step 1</p></li>
<li><p><cite>tosca_elements_map_file</cite> points to the name of the file created in Step 2</p></li>
</ul>
<p>Paths to the specified files must be absolute or from the directory where
provider configuration file is located.</p>
<p>Configuration tools are configured for every provider in provider configuration file.
Settings must be in section names with the configuration tool. For example:</p>
<p>~~~ini
[ansible]
module_prefix = <a href="#id9"><span class="problematic" id="id10">os_</span></a>
module_description = Create OpenStack component
~~~</p>
<ul class="simple">
<li><p><cite>module_prefix</cite> is added to the name of provider component type, for example if openstack.nodes.Server is created
then <cite>os_server</cite> Ansible module will be used</p></li>
<li><p><cite>module_description</cite> is added as a description to the Ansible module</p></li>
</ul>
<p>Every configuration tool can have it’s own setting parameters</p>
<p>If the mapping from Step 2 uses TOSCA <cite>node_filter</cite>
([example](<a class="reference external" href="http://docs.oasis-open.org/tosca/TOSCA-Simple-Profile-YAML/v1.0/os/TOSCA-Simple-Profile-YAML-v1.0-os.html#_Toc471725299">http://docs.oasis-open.org/tosca/TOSCA-Simple-Profile-YAML/v1.0/os/TOSCA-Simple-Profile-YAML-v1.0-os.html#_Toc471725299</a>)),
then the following section must be specified for every supported configuration tool:</p>
<p>~~~ini
[ansible.node_filter]
node_filter_source_prefix = <a href="#id11"><span class="problematic" id="id12">os_</span></a>
node_filter_source_postfix = _facts
node_filter_exceptions =</p>
<blockquote>
<div><p>subnet = os_subnets_facts</p>
</div></blockquote>
<dl class="simple">
<dt>node_filter_inner_variable =</dt><dd><p>image = ansible_facts,openstack_image
flavor = ansible_facts,openstack_flavors</p>
</dd>
</dl>
<p>~~~</p>
<ul class="simple">
<li><p><cite>node_filter_source_prefix</cite>, <cite>node_filter_source_postfix</cite> is added to the name of provider component type,
for example if openstack.nodes.Server is need to be filtered
then <cite>os_server_facts</cite> Ansible module will be used</p></li>
<li><p><cite>node_filter_exceptions</cite> is of key = value format and is used if prefix and postfix is not enough,
for example openstack.nodes.Subnet would be filtered by <cite>os_subnets_facts</cite> not <cite>os_subnet_facts</cite></p></li>
<li><p><cite>node_filter_inner_variable</cite> is used to specify JSON keys if facts were received not as list,
for example facts for openstack.nodes.Image would be received by module <cite>os_image_facts</cite> and the return value
would be <cite>image_facts = output_os_image_facts[“ansible_facts”][“openstack_image”]</cite></p></li>
</ul>
</section>
</section>


    </div>
      
  </div>
</div>
<footer class="footer">
  <div class="container">
    <p class="pull-right">
      <a href="#">Back to top</a>
      
    </p>
    <p>
        &copy; Copyright 2021, ISP RAS.<br/>
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 4.3.1.<br/>
    </p>
  </div>
</footer>
  </body>
</html>